# 审计规则与验证逻辑

## 审计目标

财务审计脚本执行以下四个核心审计目标：

### 1. 资产负债平衡验证

**验证逻辑**: 资产总计 = 负债总计 + 所有者权益总计

这是资产负债表最基本的平衡公式，确保报表在整体上是平衡的。

**验证结果**:
- 通过: 差异在容忍误差范围内（默认 ±0.01）
- 不通过: 差异超过容忍误差

### 2. 利润表项目核对

**验证逻辑**: 利润表各项目金额 = 对应明细表汇总金额

将利润表中的每个项目（营业收入、营业成本等）与利润明细表中的对应项目进行核对。

**验证结果**:
- 对每个利润项目显示：利润表金额、明细表金额、差异、是否匹配
- 统计匹配/不匹配项目数量

### 3. 科目变动追踪

**验证逻辑**: 期初余额 + 本期变动 = 期末余额

对资产负债表中的每个科目，验证：
- 资产类科目: 期末余额 = 期初余额 + 借方变动 - 贷方变动
- 负债权益类科目: 期末余额 = 期初余额 + 贷方变动 - 借方变动

**验证结果**:
- 科目变动分析表显示每个科目的期初、期末、借方变动、贷方变动
- 标记不平衡的科目

### 4. 报表勾稽关系验证

**验证逻辑**: 资产负债表与利润表之间的勾稽关系

主要勾稽关系：
- 未分配利润变动 ≈ 净利润（考虑利润分配）
- 留存收益变动应与本期净利润相关

**验证结果**:
- 显示净利润金额
- 显示未分配利润变动金额
- 验证勾稽关系是否通过

## 审计输出

审计完成后生成以下输出：

### 1. 控制台审计报告

```
================================================================================
                              财务审计报告 - 本期
================================================================================

一、审计概述
--------------------------------------------------------------------------------
审计结果: 通过 ✓

二、资产负债表审计
--------------------------------------------------------------------------------
资产总计: ¥1,000,000.00
负债总计: ¥600,000.00
所有者权益总计: ¥400,000.00
资产负债平衡: 是 ✓

三、利润表审计
--------------------------------------------------------------------------------
利润项目匹配: 5/5

四、报表勾稽关系
--------------------------------------------------------------------------------
净利润: ¥100,000.00
未分配利润变动: ¥100,000.00
勾稽关系验证: 通过 ✓

五、不平衡项目清单
--------------------------------------------------------------------------------
  无不平衡项目

================================================================================
                                 审计完成
================================================================================
```

### 2. Excel 审计报告

当使用 `--output` 参数时，导出包含以下 Sheet 的 Excel 文件：

| Sheet | 内容 |
|-------|------|
| 审计报告 | 完整的审计报告文本 |
| 科目变动分析 | 每个科目的期初、期末、变动明细 |
| 交易影响追踪 | 每笔交易对各科目的影响 |
| 利润表核对 | 利润表项目与明细表的核对结果 |
| 不平衡项 | 所有不平衡项目的清单 |

### 3. 科目变动分析表

展示每个科目的完整变动情况：

| 科目 | 科目类型 | 期初余额 | 借方变动 | 贷方变动 | 净变动 | 期末余额 | 是否平衡 | 差异 |
|------|----------|----------|----------|----------|--------|----------|----------|------|
| 货币资金 | 资产 | 100000 | 20000 | 0 | 20000 | 120000 | 是 | 0 |
| 应收账款 | 资产 | 50000 | 0 | 5000 | -5000 | 45000 | 是 | 0 |

### 4. 不平衡项清单

汇总所有不平衡的项目：

| 科目/项目 | 类型 | 差异 |
|-----------|------|------|
| 应付账款 | 资产负债表科目 | 100.50 |
| 销售费用 | 利润表项目 | 25.00 |

## 常见问题与解决

### 1. 资产负债表不平衡

**可能原因**:
- 科目余额录入错误
- 合计计算错误
- 期初期末不匹配

**解决方法**:
1. 检查资产负债表的合计行
2. 验证各科目余额是否正确
3. 检查科目类型分类是否正确

### 2. 科目变动不平衡

**可能原因**:
- 科目变动明细表遗漏
- 借贷方向错误
- 科目名称不匹配

**解决方法**:
1. 确保科目名称在两个文件中完全一致
2. 检查借方和贷方是否记录正确
3. 验证是否遗漏了某些变动记录

### 3. 利润表不匹配

**可能原因**:
- 利润明细表遗漏项目
- 项目名称不一致
- 明细汇总计算错误

**解决方法**:
1. 确保利润明细表包含所有利润表项目
2. 检查项目名称是否完全一致
3. 验证明细表的汇总计算

### 4. 勾稽关系不通过

**可能原因**:
- 有利润分配（如分红、提取盈余公积）
- 会计期间不匹配
- 净利润计算错误

**解决方法**:
1. 考虑是否有利润分配事项
2. 验证利润表的净利润计算
3. 确认资产负债表和利润表期间一致

## 容忍误差设置

默认容忍误差为 ±0.01 元，可通过 `--tolerance` 参数调整：

```bash
# 设置容忍误差为 ±1 元
scripts/reconcile.py \
    --balance-sheet bs.xlsx \
    --account-changes ac.xlsx \
    --tolerance 1.0
```

容忍误差的设置应考虑：
- 汇率波动（如果涉及外币）
- 系统精度差异
- 四舍五入误差
